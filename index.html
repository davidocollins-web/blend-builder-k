<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blend Builder K ‚Äì Recorded Audio</title>
  <style>
    :root {
      --bg:#f7fbff; --card:#fff; --ink:#1f2937; --muted:#6b7280; --accent:#2563eb;
      --good:#15803d; --warn:#b45309; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Avenir Next","Segoe UI",Arial,sans-serif;background:var(--bg);color:var(--ink);padding:16px}
    .wrap{max-width:900px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 4px 16px rgba(0,0,0,.04);margin-bottom:14px}
    h1{margin:0 0 6px;font-size:1.5rem}
    .sub{margin:0;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .phonemes{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:14px 0;min-height:70px}
    .chip{min-width:80px;text-align:center;padding:14px;border-radius:14px;border:2px solid var(--border);font-size:1.5rem;font-weight:700;background:#fff}
    .word{text-align:center;font-size:2rem;font-weight:800;min-height:46px;margin:0 0 8px}
    .imgbox{display:flex;justify-content:center;align-items:center;min-height:70px;font-size:2.8rem;margin-bottom:8px}
    button,select,input{font:inherit}
    button{border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .small{font-size:.92rem;color:var(--muted)}
    .good{color:var(--good);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
    .stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .pill{padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
    .err{margin-top:8px;padding:10px;border:1px dashed #f59e0b;border-radius:10px;background:#fffbeb;color:#92400e}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Blend Builder K (Recorded Audio)</h1>
      <p class="sub">True phoneme audio for consistent kindergarten blending practice.</p>
      <div class="row" style="margin-top:10px">
        <label for="difficulty" class="small">Set:</label>
        <select id="difficulty">
          <option value="cvc">CVC (m, t, a, c, o, i, g, d)</option>
          <option value="digraph">Digraphs (ch, th, sh)</option>
        </select>
        <label class="row small" style="gap:6px">
          <input type="checkbox" id="autoBlend" checked />
          Auto-play whole word after sounds
        </label>
      </div>
    </div>

    <div class="card">
      <div class="imgbox" id="emojiHint">üß©</div>
      <div class="phonemes" id="phonemeBoxes"></div>
      <div class="word" id="wordDisplay"></div>

      <div class="row">
        <button id="btnSounds" class="primary">üîä Say Sounds</button>
        <button id="btnBlend">üó£Ô∏è Blend Word</button>
        <button id="btnSlow">üê¢ Slow Blend</button>
        <button id="btnNew">üé≤ New Word</button>
        <button id="btnReveal">üëÄ Reveal / Hide Word</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnCorrect">‚úÖ Child Read It</button>
        <button id="btnRetry">üîÅ Needs Another Try</button>
        <button id="btnReset">üßπ Reset Score</button>
      </div>

      <p id="feedback" class="small" style="margin:10px 0 0">Tap ‚ÄúSay Sounds‚Äù to start.</p>
      <div class="stats">
        <span class="pill">Tried: <strong id="tried">0</strong></span>
        <span class="pill">Correct: <strong id="correct">0</strong></span>
        <span class="pill">Accuracy: <strong id="acc">0%</strong></span>
      </div>

      <div id="audioError" class="err hidden"></div>
    </div>
  </div>

  <script>
    // ---------- Word banks ----------
    const CVC_WORDS = [
      { word:"mat", phonemes:["m","a","t"], emoji:"üßò" },
      { word:"mad", phonemes:["m","a","d"], emoji:"üò†" },
      { word:"dad", phonemes:["d","a","d"], emoji:"üë®" },
      { word:"dig", phonemes:["d","i","g"], emoji:"‚õèÔ∏è" },
      { word:"dog", phonemes:["d","o","g"], emoji:"üê∂" },
      { word:"cat", phonemes:["c","a","t"], emoji:"üê±" },
      { word:"cot", phonemes:["c","o","t"], emoji:"üõèÔ∏è" },
      { word:"cod", phonemes:["c","o","d"], emoji:"üêü" },
      { word:"tag", phonemes:["t","a","g"], emoji:"üè∑Ô∏è" },
      { word:"tam", phonemes:["t","a","m"], emoji:"üß¢" },
      { word:"mom", phonemes:["m","o","m"], emoji:"üë©" },
      { word:"gig", phonemes:["g","i","g"], emoji:"üéµ" },
      { word:"got", phonemes:["g","o","t"], emoji:"‚úÖ" },
      { word:"dot", phonemes:["d","o","t"], emoji:"üî¥" }
    ];

    const DIGRAPH_WORDS = [
      { word:"chat", phonemes:["ch","a","t"], emoji:"üí¨" },
      { word:"chin", phonemes:["ch","i","n"], emoji:"üôÇ" },
      { word:"shop", phonemes:["sh","o","p"], emoji:"üõçÔ∏è" },
      { word:"ship", phonemes:["sh","i","p"], emoji:"üö¢" },
      { word:"thin", phonemes:["th","i","n"], emoji:"üìè" },
      { word:"that", phonemes:["th","a","t"], emoji:"üëâ" }
    ];

    // ---------- Audio file mapping ----------
    // Put these files in /audio exactly as named.
    const PHONEME_AUDIO = {
      m: "audio/m.mp3",
      t: "audio/t.mp3",
      d: "audio/d.mp3",
      c: "audio/c.mp3",      // hard /k/
      g: "audio/g.mp3",
      a: "audio/a_short.mp3",
      i: "audio/i_short.mp3",
      o: "audio/o_short.mp3",
      ch:"audio/ch.mp3",
      sh:"audio/sh.mp3",
      th:"audio/th.mp3"
    };

    // Word audio files
    // Ex: audio/words/dad.mp3, audio/words/that.mp3
    function wordAudioPath(word){ return `audio/words/${word}.mp3`; }

    // ---------- UI refs ----------
    const phonemeBoxes = document.getElementById("phonemeBoxes");
    const wordDisplay  = document.getElementById("wordDisplay");
    const emojiHint    = document.getElementById("emojiHint");
    const feedback     = document.getElementById("feedback");
    const difficulty   = document.getElementById("difficulty");
    const autoBlend    = document.getElementById("autoBlend");
    const triedEl      = document.getElementById("tried");
    const correctEl    = document.getElementById("correct");
    const accEl        = document.getElementById("acc");
    const audioError   = document.getElementById("audioError");

    const btnSounds  = document.getElementById("btnSounds");
    const btnBlend   = document.getElementById("btnBlend");
    const btnSlow    = document.getElementById("btnSlow");
    const btnNew     = document.getElementById("btnNew");
    const btnReveal  = document.getElementById("btnReveal");
    const btnCorrect = document.getElementById("btnCorrect");
    const btnRetry   = document.getElementById("btnRetry");
    const btnReset   = document.getElementById("btnReset");

    let current = null;
    let showWord = false;
    let tried = Number(localStorage.getItem("bb2_tried") || 0);
    let correct = Number(localStorage.getItem("bb2_correct") || 0);

    function saveStats(){
      localStorage.setItem("bb2_tried", tried);
      localStorage.setItem("bb2_correct", correct);
      renderStats();
    }
    function renderStats(){
      triedEl.textContent = tried;
      correctEl.textContent = correct;
      const pct = tried ? Math.round((correct/tried)*100) : 0;
      accEl.textContent = pct + "%";
    }

    function getBank(){ return difficulty.value === "digraph" ? DIGRAPH_WORDS : CVC_WORDS; }

    function randomWord(){
      const bank = getBank();
      current = bank[Math.floor(Math.random()*bank.length)];
      renderCurrent();
      feedback.textContent = "New word ready. Tap ‚ÄúSay Sounds‚Äù.";
      hideAudioError();
    }

    function renderCurrent(){
      phonemeBoxes.innerHTML = "";
      current.phonemes.forEach(p=>{
        const d = document.createElement("div");
        d.className = "chip";
        d.textContent = p;
        phonemeBoxes.appendChild(d);
      });
      emojiHint.textContent = current.emoji || "üß©";
      wordDisplay.textContent = showWord ? current.word : "";
    }

    function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }

    function showAudioError(msg){
      audioError.textContent = msg;
      audioError.classList.remove("hidden");
    }
    function hideAudioError(){
      audioError.classList.add("hidden");
      audioError.textContent = "";
    }

    function playAudio(src){
      return new Promise((resolve, reject)=>{
        const a = new Audio(src);
        a.preload = "auto";
        a.onended = ()=>resolve();
        a.onerror = ()=>reject(new Error("Missing audio: " + src));
        // iPhone autoplay policy: must be user-initiated. These buttons are user clicks, so okay.
        a.play().catch(err=>reject(err));
      });
    }

    async function saySounds(){
      if(!current) return;
      hideAudioError();
      feedback.textContent = "Nice! Repeat each sound with your child.";

      try{
        for(const p of current.phonemes){
          const src = PHONEME_AUDIO[p];
          if(!src) throw new Error("No mapping for phoneme: " + p);
          await playAudio(src);
          await wait(180);
        }
        if(autoBlend.checked){
          await wait(220);
          await blendWord();
        }
      }catch(err){
        showAudioError("I couldn‚Äôt play one of the sound files. Check that your /audio files are uploaded and names match exactly.");
        console.error(err);
      }
    }

    async function blendWord(){
      if(!current) return;
      hideAudioError();
      try{
        await playAudio(wordAudioPath(current.word));
        feedback.textContent = "Now your child says the whole word.";
      }catch(err){
        showAudioError(`Missing word audio for "${current.word}". Upload: audio/words/${current.word}.mp3`);
        console.error(err);
      }
    }

    async function slowBlend(){
      if(!current) return;
      hideAudioError();
      try{
        for(const p of current.phonemes){
          await playAudio(PHONEME_AUDIO[p]);
          await wait(500);
        }
        await wait(350);
        await playAudio(wordAudioPath(current.word));
        feedback.textContent = "Use a finger sweep while blending.";
      }catch(err){
        showAudioError("A slow blend file is missing. Verify phoneme and word audio uploads.");
        console.error(err);
      }
    }

    function markCorrect(){
      tried++; correct++; saveStats();
      feedback.innerHTML = '<span class="good">Awesome! Logged as correct.</span>';
      randomWord();
    }
    function markRetry(){
      tried++; saveStats();
      feedback.innerHTML = '<span class="warn">Great effort‚Äîtry another one.</span>';
      randomWord();
    }
    function resetStats(){
      tried = 0; correct = 0; saveStats();
      feedback.textContent = "Scores reset.";
    }

    btnSounds.addEventListener("click", saySounds);
    btnBlend.addEventListener("click", blendWord);
    btnSlow.addEventListener("click", slowBlend);
    btnNew.addEventListener("click", randomWord);
    btnReveal.addEventListener("click", ()=>{
      showWord = !showWord;
      renderCurrent();
    });
    btnCorrect.addEventListener("click", markCorrect);
    btnRetry.addEventListener("click", markRetry);
    btnReset.addEventListener("click", resetStats);
    difficulty.addEventListener("change", randomWord);

    renderStats();
    randomWord();
  </script>
</body>
</html>
